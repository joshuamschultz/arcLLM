{
  "current_step": 14,
  "current_task": null,
  "completed_steps": [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 13, 14],
  "skipped_steps": [9, 12],
  "step_plans": {
    "1": {
      "file": "arcllm-step-01-plan.md",
      "status": "complete",
      "spec_id": "001",
      "tasks": [
        "1. Create directory structure",
        "2. Create pyproject.toml",
        "3. Create exceptions.py",
        "4. Create types.py",
        "5. Create __init__.py",
        "6. Create test_types.py",
        "7. Create .env.example"
      ],
      "completed_tasks": [
        "1. Create directory structure",
        "2. Create pyproject.toml",
        "3. Create exceptions.py",
        "4. Create types.py",
        "5. Create __init__.py",
        "6. Create test_types.py",
        "7. Create .env.example"
      ]
    },
    "2": {
      "status": "complete",
      "spec_id": "002",
      "tasks": [
        "T2.1 Create global config.toml",
        "T2.2 Create provider TOML files",
        "T2.3 Create config.py with models and loaders",
        "T2.4 Update __init__.py with config exports",
        "T2.5 Create test_config.py"
      ],
      "completed_tasks": [
        "T2.1 Create global config.toml",
        "T2.2 Create provider TOML files",
        "T2.3 Create config.py with models and loaders",
        "T2.4 Update __init__.py with config exports",
        "T2.5 Create test_config.py"
      ]
    },
    "3": {
      "status": "complete",
      "spec_id": "003",
      "tasks": [
        "T3.1 Add ArcLLMAPIError to exceptions.py",
        "T3.2 Create BaseAdapter in adapters/base.py",
        "T3.3 Create AnthropicAdapter in adapters/anthropic.py",
        "T3.4 Write comprehensive test_anthropic.py",
        "T3.5 Update __init__.py with new exports"
      ],
      "completed_tasks": [
        "T3.1 Add ArcLLMAPIError to exceptions.py",
        "T3.2 Create BaseAdapter in adapters/base.py",
        "T3.3 Create AnthropicAdapter in adapters/anthropic.py",
        "T3.4 Write comprehensive test_anthropic.py",
        "T3.5 Update __init__.py with new exports"
      ]
    },
    "4": {
      "status": "complete",
      "tasks": [
        "T4.1 Create Jupyter notebook for agentic loop validation",
        "T4.2 Test simple text response",
        "T4.3 Test calculator tool loop (2-turn)",
        "T4.4 Test search tool loop (canned results)",
        "T4.5 Test multi-tool with agentic loop helper"
      ],
      "completed_tasks": [
        "T4.1 Create Jupyter notebook for agentic loop validation",
        "T4.2 Test simple text response",
        "T4.3 Test calculator tool loop (2-turn)",
        "T4.4 Test search tool loop (canned results)",
        "T4.5 Test multi-tool with agentic loop helper"
      ]
    },
    "5": {
      "status": "complete",
      "spec_id": "005",
      "tasks": [
        "T5.1 Add StopReason type to types.py",
        "T5.2 Write test_openai.py (TDD RED)",
        "T5.3 Create OpenaiAdapter in adapters/openai.py",
        "T5.4 Update __init__.py with new exports",
        "T5.5 Full test suite verification"
      ],
      "completed_tasks": [
        "T5.1 Add StopReason type to types.py",
        "T5.2 Write test_openai.py (TDD RED)",
        "T5.3 Create OpenaiAdapter in adapters/openai.py",
        "T5.4 Update __init__.py with new exports",
        "T5.5 Full test suite verification"
      ]
    },
    "6": {
      "status": "complete",
      "spec_id": "006",
      "tasks": [
        "T6.1 Rename OpenAIAdapter to OpenaiAdapter",
        "T6.2 Write test_registry.py (TDD RED)",
        "T6.3 Create registry.py",
        "T6.4 Update __init__.py",
        "T6.5 Full test suite verification"
      ],
      "completed_tasks": [
        "T6.1 Rename OpenAIAdapter to OpenaiAdapter",
        "T6.2 Write test_registry.py (TDD RED)",
        "T6.3 Create registry.py",
        "T6.4 Update __init__.py",
        "T6.5 Full test suite verification"
      ]
    },
    "7": {
      "status": "complete",
      "spec_id": "007",
      "tasks": [
        "T7.1 Update ArcLLMAPIError with status_code",
        "T7.2 Create BaseModule in modules/base.py",
        "T7.3 Write test_retry.py (TDD RED)",
        "T7.4 Implement RetryModule in modules/retry.py",
        "T7.5 Write test_fallback.py (TDD RED)",
        "T7.6 Implement FallbackModule in modules/fallback.py",
        "T7.7 Update registry.py for module stacking",
        "T7.8 Full test suite verification"
      ],
      "completed_tasks": [
        "T7.1 Update ArcLLMAPIError with status_code",
        "T7.2 Create BaseModule in modules/base.py",
        "T7.3 Write test_retry.py (TDD RED)",
        "T7.4 Implement RetryModule in modules/retry.py",
        "T7.5 Write test_fallback.py (TDD RED)",
        "T7.6 Implement FallbackModule in modules/fallback.py",
        "T7.7 Update registry.py for module stacking",
        "T7.8 Full test suite verification"
      ]
    },
    "8": {
      "status": "complete",
      "spec_id": "008",
      "tasks": [
        "T8.1 Update config.toml with burst_capacity",
        "T8.2 Write test_rate_limit.py (TDD RED)",
        "T8.3 Implement TokenBucket class",
        "T8.4 Implement RateLimitModule",
        "T8.5 Update registry.py and exports",
        "T8.6 Update config.toml",
        "T8.7 Full test suite verification"
      ],
      "completed_tasks": [
        "T8.1 Update config.toml with burst_capacity",
        "T8.2 Write test_rate_limit.py (TDD RED)",
        "T8.3 Implement TokenBucket class",
        "T8.4 Implement RateLimitModule",
        "T8.5 Update registry.py and exports",
        "T8.6 Update config.toml",
        "T8.7 Full test suite verification"
      ]
    },
    "9": {
      "status": "skipped",
      "reason": "User deferred router module — can add later"
    },
    "10": {
      "status": "complete",
      "spec_id": "009",
      "tasks": [
        "T10.1 Update config.toml with telemetry log_level",
        "T10.2 Write test_telemetry.py (TDD RED)",
        "T10.3 Implement TelemetryModule in modules/telemetry.py",
        "T10.4 Update registry.py with telemetry kwarg and pricing injection",
        "T10.5 Update __init__.py and modules/__init__.py exports",
        "T10.6 Full test suite verification"
      ],
      "completed_tasks": [
        "T10.1 Update config.toml with telemetry log_level",
        "T10.2 Write test_telemetry.py (TDD RED)",
        "T10.3 Implement TelemetryModule in modules/telemetry.py",
        "T10.4 Update registry.py with telemetry kwarg and pricing injection",
        "T10.5 Update __init__.py and modules/__init__.py exports",
        "T10.6 Full test suite verification"
      ]
    },
    "11": {
      "status": "complete",
      "spec_id": "010",
      "tasks": [
        "T11.1 Verify config.toml audit section",
        "T11.2 Write test_audit.py (TDD RED)",
        "T11.3 Implement AuditModule in modules/audit.py",
        "T11.4 Update registry.py with audit kwarg",
        "T11.5 Update __init__.py and modules/__init__.py exports",
        "T11.6 Full test suite verification",
        "T11.7 Update state and decision log"
      ],
      "completed_tasks": [
        "T11.1 Verify config.toml audit section",
        "T11.2 Write test_audit.py (TDD RED)",
        "T11.3 Implement AuditModule in modules/audit.py",
        "T11.4 Update registry.py with audit kwarg",
        "T11.5 Update __init__.py and modules/__init__.py exports",
        "T11.6 Full test suite verification",
        "T11.7 Update state and decision log"
      ]
    },
    "12": {
      "status": "skipped",
      "reason": "User jumped to Step 13 (OTel) — budget manager deferred"
    },
    "13": {
      "status": "complete",
      "spec_id": "011",
      "tasks": [
        "T13.1 Add opentelemetry-api to core deps and otel extras",
        "T13.2 Add [modules.otel] section to config.toml",
        "T13.3 Add _tracer and _span() to BaseModule",
        "T13.4 Write test_otel.py (TDD RED)",
        "T13.5 Implement OtelModule in modules/otel.py",
        "T13.6 Write test_otel_integration.py (TDD RED)",
        "T13.7 Add span creation to all existing modules",
        "T13.8 Update registry.py with otel= kwarg",
        "T13.9 Update __init__.py and modules/__init__.py exports",
        "T13.10 Full test suite verification"
      ],
      "completed_tasks": [
        "T13.1 Add opentelemetry-api to core deps and otel extras",
        "T13.2 Add [modules.otel] section to config.toml",
        "T13.3 Add _tracer and _span() to BaseModule",
        "T13.4 Write test_otel.py (TDD RED)",
        "T13.5 Implement OtelModule in modules/otel.py",
        "T13.6 Write test_otel_integration.py (TDD RED)",
        "T13.7 Add span creation to all existing modules",
        "T13.8 Update registry.py with otel= kwarg",
        "T13.9 Update __init__.py and modules/__init__.py exports",
        "T13.10 Full test suite verification"
      ]
    },
    "14": {
      "status": "complete",
      "spec_id": "012",
      "tasks": [
        "T14.1 Add VaultConfig and SecurityModuleConfig to config.py",
        "T14.2 Update config.toml and provider TOMLs",
        "T14.3 Add arcllm[signing] extras to pyproject.toml",
        "T14.4 Write test_pii.py (TDD RED)",
        "T14.5 Implement _pii.py (TDD GREEN)",
        "T14.6 Write test_signing.py (TDD RED)",
        "T14.7 Implement _signing.py (TDD GREEN)",
        "T14.8 Write test_vault.py (TDD RED)",
        "T14.9 Implement vault.py (TDD GREEN)",
        "T14.10 Write test_security.py (TDD RED)",
        "T14.11 Implement SecurityModule in modules/security.py (TDD GREEN)",
        "T14.12 Update registry.py, __init__.py, modules/__init__.py"
      ],
      "completed_tasks": [
        "T14.1 Add VaultConfig and SecurityModuleConfig to config.py",
        "T14.2 Update config.toml and provider TOMLs",
        "T14.3 Add arcllm[signing] extras to pyproject.toml",
        "T14.4 Write test_pii.py (TDD RED)",
        "T14.5 Implement _pii.py (TDD GREEN)",
        "T14.6 Write test_signing.py (TDD RED)",
        "T14.7 Implement _signing.py (TDD GREEN)",
        "T14.8 Write test_vault.py (TDD RED)",
        "T14.9 Implement vault.py (TDD GREEN)",
        "T14.10 Write test_security.py (TDD RED)",
        "T14.11 Implement SecurityModule in modules/security.py (TDD GREEN)",
        "T14.12 Update registry.py, __init__.py, modules/__init__.py"
      ]
    }
  },
  "decisions": {
    "D-031_config_data_model": {
      "decision": "Pydantic models for all config types (typed configs)",
      "reason": "Fail-fast validation critical for unattended agents; pydantic already in deps",
      "date": "2026-02-07",
      "alternatives_considered": ["dataclasses + manual validation", "TypedDict / plain dicts"]
    },
    "D-032_config_validation_timing": {
      "decision": "Validate on load (fail-fast)",
      "reason": "Don't debug config during LLM call; catch errors at startup",
      "date": "2026-02-07",
      "alternatives_considered": ["validate on first use (lazy)", "two-phase (structural then semantic)"]
    },
    "D-033_config_merge_strategy": {
      "decision": "Simple override chain — args > provider > global, flat merge, last-writer-wins",
      "reason": "TOML structure is flat-ish; deep merge is overkill",
      "date": "2026-02-07",
      "alternatives_considered": ["deep merge", "explicit layers (separate objects)"]
    },
    "D-034_config_file_discovery": {
      "decision": "Package-relative via Path(__file__).parent",
      "reason": "Config ships with the library; __file__ works in dev and installed modes",
      "date": "2026-02-07",
      "alternatives_considered": ["CWD-relative", "importlib.resources", "env var override path"]
    },
    "D-035_provider_name_validation": {
      "decision": "Strict regex validation on provider_name before path construction",
      "reason": "Path traversal prevention — NIST 800-53 AC-3, OWASP A01 compliance for federal production",
      "date": "2026-02-07",
      "alternatives_considered": ["no validation", "path resolution check", "allowlist"]
    },
    "D-038_stop_reason_normalization": {
      "decision": "Canonical StopReason Literal type — adapters map provider-native values to end_turn/tool_use/max_tokens/stop_sequence",
      "reason": "Unified interface requires provider-agnostic stop checks; Literal catches typos at validation time",
      "date": "2026-02-07",
      "alternatives_considered": ["pass through provider-native values", "dual field (normalized + raw)"]
    },
    "D-039_tool_result_flattening": {
      "decision": "OpenAI adapter flattens one ArcLLM message with N ToolResultBlocks into N separate OpenAI messages",
      "reason": "Agents use same ToolResultBlock pattern regardless of provider; adapter owns translation complexity",
      "date": "2026-02-07",
      "alternatives_considered": ["require agents to use different message format per provider"]
    },
    "D-040_mirror_adapter_structure": {
      "decision": "OpenAI adapter mirrors Anthropic adapter's private-method-per-concern pattern",
      "reason": "Proven in Step 3; consistency across adapters for maintainability and learnability",
      "date": "2026-02-07",
      "alternatives_considered": ["different structure optimized for OpenAI's simpler API"]
    },
    "D-041_convention_based_registry": {
      "decision": "Provider name drives TOML path, module path, and class name by convention",
      "reason": "File structure is the registry. Zero config for discovery. No mapping dict to maintain.",
      "date": "2026-02-08",
      "alternatives_considered": ["static mapping dict", "TOML adapter_module field + importlib", "entry_points plugin system"]
    },
    "D-042_class_name_convention": {
      "decision": "provider_name.title() + 'Adapter' — renamed OpenAIAdapter to OpenaiAdapter",
      "reason": "Predictable, no exception maps. Pure convention means zero maintenance.",
      "date": "2026-02-08",
      "alternatives_considered": ["exception dict for known cases", "scan module for BaseAdapter subclass"]
    },
    "D-043_module_level_config_cache": {
      "decision": "Cache ProviderConfig in module-level dict with clear_cache() for testing",
      "reason": "Avoids re-parsing TOML per load_model() call. Essential at scale with thousands of agents.",
      "date": "2026-02-08",
      "alternatives_considered": ["load every time", "explicit Registry object"]
    },
    "D-044_no_kwargs_load_model": {
      "decision": "Remove **kwargs from load_model() — only provider and model params",
      "reason": "BaseAdapter.__init__ doesn't accept **kwargs; forwarding them causes confusing TypeError at adapter construction time instead of clear API error",
      "date": "2026-02-08",
      "alternatives_considered": ["keep **kwargs and add to BaseAdapter", "catch TypeError and wrap in ArcLLMConfigError"]
    },
    "D-045_no_hyphens_provider_names": {
      "decision": "Provider name regex allows underscores but not hyphens: ^[a-z][a-z0-9_]*$",
      "reason": "Provider name maps to Python module name via convention; hyphens are invalid in Python identifiers. Allowing them would pass validation but fail at import.",
      "date": "2026-02-08",
      "alternatives_considered": ["keep hyphens and auto-convert to underscores at import time"]
    },
    "D-046_lazy_adapter_imports": {
      "decision": "Adapter classes lazy-loaded via __getattr__ in __init__.py, not eagerly imported",
      "reason": "import arcllm should not trigger httpx loading; adapters loaded on-demand by load_model() or explicit attribute access",
      "date": "2026-02-08",
      "alternatives_considered": ["remove adapters from __init__.py entirely", "keep eager imports"]
    },
    "D-047_wrapper_module_pattern": {
      "decision": "Wrapper classes (middleware pattern) — each module is an LLMProvider wrapping an inner provider",
      "reason": "Composable, testable independently, transparent to agents. Scales to N modules without adapter changes.",
      "date": "2026-02-08",
      "alternatives_considered": ["if-checks in invoke()", "decorator pattern", "event hooks", "subclass mixin"]
    },
    "D-048_separate_retry_fallback": {
      "decision": "Two separate modules: RetryModule and FallbackModule (not combined)",
      "reason": "Single responsibility, independently configurable, can use one without the other",
      "date": "2026-02-08",
      "alternatives_considered": ["combined ResilienceModule with both behaviors"]
    },
    "D-049_retry_triggers": {
      "decision": "Retry on HTTP 429/500/502/503/529 + httpx.ConnectError + httpx.TimeoutException",
      "reason": "Industry standard retryable codes; 529 is Anthropic-specific overload",
      "date": "2026-02-08",
      "alternatives_considered": ["retry all 5xx", "configurable-only with no defaults"]
    },
    "D-050_exponential_backoff_jitter": {
      "decision": "Exponential backoff with jitter: min(base * 2^attempt + uniform(0, base), max_wait)",
      "reason": "Prevents thundering herd; jitter decorrelates concurrent retriers",
      "date": "2026-02-08",
      "alternatives_considered": ["fixed delay", "exponential without jitter", "full jitter"]
    },
    "D-051_config_driven_fallback_chain": {
      "decision": "Config-driven fallback chain with on-demand load_model() for each fallback provider",
      "reason": "Only creates fallback adapters when needed; chain order from config.toml",
      "date": "2026-02-08",
      "alternatives_considered": ["pre-loaded fallback adapters at construction time"]
    },
    "D-052_proportional_jitter": {
      "decision": "Jitter proportional to backoff: uniform(0, backoff) not uniform(0, base)",
      "reason": "Review fix — fixed jitter scales with exponential backoff to better prevent thundering herd at higher retry attempts",
      "date": "2026-02-08",
      "alternatives_considered": ["fixed jitter uniform(0, base)", "full jitter: uniform(0, backoff) replacing backoff entirely"]
    },
    "D-053_module_config_validation": {
      "decision": "Bounds validation in RetryModule and FallbackModule constructors",
      "reason": "Review fix — 3 agents flagged missing input validation. Invalid configs should fail at construction, not during operation.",
      "date": "2026-02-08",
      "alternatives_considered": ["pydantic config models", "no validation (rely on runtime errors)"]
    },
    "D-054_module_settings_cache": {
      "decision": "Pre-extract module settings dict from pydantic model_dump() into _module_settings_cache",
      "reason": "Review fix — avoids repeated model_dump() calls (2x per load_model() call). Cache populated on first global config load.",
      "date": "2026-02-08",
      "alternatives_considered": ["call model_dump() each time", "store raw pydantic objects"]
    },
    "D-055_rate_limit_algorithm": {
      "decision": "Token bucket algorithm — capacity=burst size, refill_rate=RPM/60 tokens/sec",
      "reason": "Allows bursts (good for agents waking simultaneously), enforces average rate, battle-tested (nginx, AWS API Gateway)",
      "date": "2026-02-08",
      "alternatives_considered": ["sliding window counter", "leaky bucket", "adaptive (monitor 429s)"]
    },
    "D-056_rate_limit_scope": {
      "decision": "Per-provider shared buckets — all agents using same API key share one bucket",
      "reason": "Matches how provider rate limits actually work. Per-instance would multiply the effective rate.",
      "date": "2026-02-08",
      "alternatives_considered": ["per-model-instance", "global single bucket", "per-model per-provider"]
    },
    "D-057_shared_state_pattern": {
      "decision": "Module-level registry dict in rate_limit.py — consistent with config cache pattern in registry.py",
      "reason": "Simple, testable via clear_buckets(), same pattern used for config caching",
      "date": "2026-02-08",
      "alternatives_considered": ["class-level (on RateLimitModule)", "separate SharedState singleton"]
    },
    "D-058_throttle_behavior": {
      "decision": "Block (async wait) + WARNING log when throttled",
      "reason": "Transparent to agents, ops gets visibility into throttling via logs",
      "date": "2026-02-08",
      "alternatives_considered": ["raise exception (immediate fail)", "callback/event notification", "silent wait"]
    },
    "D-059_burst_config": {
      "decision": "Separate burst_capacity param, defaults to requests_per_minute, overridable via load_model()",
      "reason": "Global default in config.toml, overridable per-call. burst_capacity defaults to RPM for sane defaults.",
      "date": "2026-02-08",
      "alternatives_considered": ["always equal to RPM", "hardcoded burst factor"]
    },
    "D-060_stack_order": {
      "decision": "Rate limit innermost: Retry(Fallback(RateLimit(adapter)))",
      "reason": "Rate limit wraps adapter directly — each actual API call is throttled. Retry/fallback wrap outside.",
      "date": "2026-02-08",
      "alternatives_considered": ["outermost", "between retry and fallback"]
    },
    "D-061_provider_id": {
      "decision": "Read inner.name for bucket lookup key",
      "reason": "Consistent with LLMProvider.name property, already available, no extra config needed",
      "date": "2026-02-08",
      "alternatives_considered": ["separate provider_name config key", "read from provider TOML"]
    },
    "D-062_validation": {
      "decision": "RPM > 0, burst_capacity >= 1 — raise ArcLLMConfigError on invalid values",
      "reason": "Fail fast at construction, consistent with RetryModule/FallbackModule validation pattern",
      "date": "2026-02-08",
      "alternatives_considered": ["clamp to minimums silently", "warning log only"]
    },
    "D-063_test_cleanup": {
      "decision": "clear_buckets() function + hooked into registry.clear_cache()",
      "reason": "Test isolation requires clearing shared state between tests. Automatic via clear_cache().",
      "date": "2026-02-08",
      "alternatives_considered": ["fixture-only cleanup", "no shared state (per-instance buckets)"]
    },
    "D-064_telemetry_output": {
      "decision": "Structured logging only — no callback, no accumulator",
      "reason": "Simple, toggle-able via config, no functions in load_model() config. Budget and OTel handle their own concerns.",
      "date": "2026-02-08",
      "alternatives_considered": ["callback function", "in-memory accumulator", "both logging + callback"]
    },
    "D-065_telemetry_cost": {
      "decision": "Calculate and log cost_usd per call from provider pricing metadata",
      "reason": "Pricing already in provider TOML; cost per call is essential for budget tracking and ops visibility",
      "date": "2026-02-08",
      "alternatives_considered": ["log tokens only, no cost", "separate cost module"]
    },
    "D-066_pricing_injection": {
      "decision": "load_model() injects pricing from ProviderConfig model metadata into telemetry config dict via setdefault()",
      "reason": "Pricing lives in provider TOML, TelemetryModule shouldn't know about ProviderConfig. setdefault() allows explicit overrides.",
      "date": "2026-02-08",
      "alternatives_considered": ["TelemetryModule reads ProviderConfig directly", "separate pricing config section"]
    },
    "D-067_telemetry_stack_order": {
      "decision": "Telemetry outermost: Telemetry(Retry(Fallback(RateLimit(adapter))))",
      "reason": "Measures total wall-clock including retries, fallback, and rate-limit wait. Most useful operational metric.",
      "date": "2026-02-08",
      "alternatives_considered": ["innermost (just adapter time)", "between retry and fallback"]
    },
    "D-068_telemetry_log_level": {
      "decision": "INFO by default, configurable via log_level in config dict",
      "reason": "Telemetry should be visible when enabled. Configurable for noisy environments.",
      "date": "2026-02-08",
      "alternatives_considered": ["DEBUG (too quiet by default)", "fixed INFO (not configurable)"]
    },
    "D-069_telemetry_log_fields": {
      "decision": "provider, model, duration_ms, input_tokens, output_tokens, total_tokens, cache_read/write_tokens (conditional), cost_usd, stop_reason",
      "reason": "Complete operational visibility per call. Cache tokens omitted when absent to reduce noise.",
      "date": "2026-02-08",
      "alternatives_considered": ["minimal (just timing + cost)", "include raw response size"]
    },
    "D-070_audit_output": {
      "decision": "Structured logging using shared log_structured() helper from _logging.py",
      "reason": "Consistent with telemetry. Shared helper handles sanitization, None omission, float formatting. One place to change format.",
      "date": "2026-02-08",
      "alternatives_considered": ["manual f-string building", "separate audit log format"]
    },
    "D-071_audit_log_level": {
      "decision": "INFO by default, configurable via log_level. Same validation pattern as TelemetryModule.",
      "reason": "Audit events should be visible by default for compliance.",
      "date": "2026-02-08",
      "alternatives_considered": ["DEBUG default", "CRITICAL default"]
    },
    "D-072_audit_fields": {
      "decision": "provider, model, message_count, stop_reason, tools_provided (conditional), tool_calls (conditional), content_length",
      "reason": "Covers compliance-relevant metadata (NIST 800-53 AU-3) without PII exposure.",
      "date": "2026-02-08",
      "alternatives_considered": ["include raw content", "include timing (telemetry concern)", "include token usage (telemetry concern)"]
    },
    "D-073_pii_safe_audit": {
      "decision": "No raw message content or response content logged by default",
      "reason": "Federal compliance: audit trail must not create new PII exposure vectors.",
      "date": "2026-02-08",
      "alternatives_considered": ["always log content", "truncate content", "hash content"]
    },
    "D-074_content_opt_in": {
      "decision": "include_messages and include_response boolean flags, content logged at DEBUG level",
      "reason": "Double opt-in: config flag + DEBUG enabled. Production typically has DEBUG disabled.",
      "date": "2026-02-08",
      "alternatives_considered": ["log at same level as audit record", "require both flags"]
    },
    "D-075_security_tool_validator_step": {
      "decision": "Tool Call Validator and Content Scanner as Steps 17-18 (not folded into Step 14)",
      "reason": "Keep Step 14 focused on vault/signing/PII. Tool validation and content scanning are distinct concerns.",
      "date": "2026-02-09",
      "alternatives_considered": ["fold into Step 14", "skip for now"]
    },
    "D-076_trace_context_in_base_module": {
      "decision": "Bake request_id/trace context into BaseModule — every module inherits it automatically",
      "reason": "Trace context is cross-cutting. Generating in BaseModule means audit, telemetry, and OTel all get it for free.",
      "date": "2026-02-09",
      "alternatives_considered": ["separate TraceContextModule", "defer to OTel only"]
    },
    "D-077_pii_redaction_both_directions": {
      "decision": "PII redaction scans both outbound messages (to LLM) and inbound responses (from LLM)",
      "reason": "Federal compliance: prevent PII from reaching provider AND prevent PII in responses from propagating through agent system.",
      "date": "2026-02-09",
      "alternatives_considered": ["responses only", "outbound only"]
    },
    "D-078_compliance_docs_after_step_16": {
      "decision": "Create SBOM, threat model, and IR runbook as documentation pass after Step 16",
      "reason": "Complete all code first, then document with full context of what was actually built.",
      "date": "2026-02-09",
      "alternatives_considered": ["during relevant steps", "now"]
    },
    "D-079_otel_integration_depth": {
      "decision": "Deep integration — BaseModule + per-module spans for full trace waterfall",
      "reason": "Full trace waterfall showing retry attempts, fallback hops, rate-limit waits. Richest operational data for 10K agents.",
      "date": "2026-02-09",
      "alternatives_considered": ["OTel Module only (single span)", "OTel Module + optional context propagation"]
    },
    "D-080_otel_api_dependency": {
      "decision": "opentelemetry-api as core dependency (not optional)",
      "reason": "~100KB, zero transitive deps, designed for library authors. No-op when SDK not configured. Always available, no import guards needed.",
      "date": "2026-02-09",
      "alternatives_considered": ["optional with import guard"]
    },
    "D-081_otel_root_span": {
      "decision": "OtelModule creates root span, auto-nests under parent context from agent framework",
      "reason": "Works standalone (traces without agent framework) AND auto-nests as child span when agent framework provides parent. Best of both worlds.",
      "date": "2026-02-09",
      "alternatives_considered": ["library spans only (no root)", "auto-span in BaseModule"]
    },
    "D-082_otel_attributes": {
      "decision": "GenAI semantic conventions (gen_ai.*) + custom arcllm.* attributes",
      "reason": "Standard gen_ai.* for vendor dashboard auto-detection (Datadog, Grafana). Custom arcllm.* for cost, retry, rate-limit details.",
      "date": "2026-02-09",
      "alternatives_considered": ["custom only", "standard only"]
    },
    "D-083_otel_sdk_setup": {
      "decision": "Config-driven SDK setup via [modules.otel] TOML section",
      "reason": "Consistent with all other ArcLLM config. Operators configure exporter, endpoint, protocol, sampling via TOML.",
      "date": "2026-02-09",
      "alternatives_considered": ["no SDK helpers (pure library)", "convenience setup function"]
    },
    "D-084_otel_sdk_packages": {
      "decision": "opentelemetry-sdk + OTLP exporters as optional extras: pip install arcllm[otel]",
      "reason": "SDK + exporters are heavier (~1MB). Clear ArcLLMConfigError if enabled but not installed. Keeps base install light.",
      "date": "2026-02-09",
      "alternatives_considered": ["core dependencies"]
    },
    "D-085_otel_telemetry_overlap": {
      "decision": "Keep TelemetryModule and OtelModule as separate concerns (logs vs traces)",
      "reason": "TelemetryModule = structured logs (grep/Splunk). OtelModule = distributed traces (Jaeger/Datadog). Different observability pillars, both valuable.",
      "date": "2026-02-09",
      "alternatives_considered": ["OtelModule replaces TelemetryModule", "TelemetryModule reads from OTel spans"]
    },
    "D-086_otel_span_mechanism": {
      "decision": "BaseModule provides _tracer property and _span() context manager helper",
      "reason": "Each module explicitly wraps its logic. Gives modules control over span timing and attributes. Works with complex retry/fallback logic.",
      "date": "2026-02-09",
      "alternatives_considered": ["auto in BaseModule.invoke()", "@traced decorator"]
    },
    "D-087_otel_error_recording": {
      "decision": "Record exceptions as span events, ERROR status only on final failure",
      "reason": "Individual retry attempts: exception event but OK status (handled). Root span ERROR only when operation truly fails. Clean trace UI.",
      "date": "2026-02-09",
      "alternatives_considered": ["mark each failure as ERROR"]
    },
    "D-088_otel_config_shape": {
      "decision": "Full enterprise config: exporter, endpoint, protocol, sample_rate, headers, TLS (insecure, CA cert, client cert/key), batch tuning, resource_attributes",
      "reason": "mTLS for federal/zero-trust. Auth headers for cloud collectors. Batch tuning for 10K agents. Resource attributes for deployment metadata.",
      "date": "2026-02-09",
      "alternatives_considered": ["minimal config", "basic without TLS"]
    },
    "D-089_security_module_structure": {
      "decision": "Two modules: VaultResolver (construction-time key resolution) + SecurityModule (per-invoke PII + signing)",
      "reason": "Vault is a one-time setup concern (resolve key before adapter construction). PII+signing are per-request concerns. Different lifecycles = different modules.",
      "date": "2026-02-11",
      "alternatives_considered": ["single SecurityModule for all three", "three separate modules"]
    },
    "D-090_vault_abstraction": {
      "decision": "Protocol + extras pattern — VaultBackend protocol, backends loaded via importlib from config string, pip install arcllm[aws] for AWS support",
      "reason": "User wanted simplicity: set backend in config, install extra, it just works. No unused backends loaded.",
      "date": "2026-02-11",
      "alternatives_considered": ["built-in backends", "env-var-only (no vault)"]
    },
    "D-091_vault_fallback": {
      "decision": "Vault first, env var fallback — try vault, fall back to os.environ if vault unavailable",
      "reason": "Vault is authoritative when configured, but env var provides graceful degradation for dev/test environments.",
      "date": "2026-02-11",
      "alternatives_considered": ["vault only (no fallback)", "env var first, vault override"]
    },
    "D-092_key_caching": {
      "decision": "TTL-based cache with time.monotonic(), default 300 seconds",
      "reason": "Avoids hammering vault on every load_model() call. time.monotonic() immune to clock skew. 5min default balances freshness vs performance.",
      "date": "2026-02-11",
      "alternatives_considered": ["no caching", "indefinite cache with manual invalidation", "LRU cache"]
    },
    "D-093_pii_detection": {
      "decision": "Regex-based with pluggable PiiDetector protocol — built-in patterns + custom regex + extensible to presidio/spacy via protocol",
      "reason": "User wanted: default regex works out of box, easy to add custom patterns, extensible to presidio or spacy models via PiiDetector protocol. No unused deps loaded.",
      "date": "2026-02-11",
      "alternatives_considered": ["regex only (no extensibility)", "presidio default", "NER-based"]
    },
    "D-094_pii_redaction_format": {
      "decision": "Type-tagged placeholders: [PII:SSN], [PII:EMAIL], [PII:PHONE] etc.",
      "reason": "Preserves information about what was redacted for audit/debugging without exposing actual PII. Agents can still reason about content structure.",
      "date": "2026-02-11",
      "alternatives_considered": ["generic [REDACTED]", "Unicode replacement character", "empty string"]
    },
    "D-095_signing_algorithm": {
      "decision": "Both: HMAC-SHA256 default (stdlib) + ECDSA P-256 optional (arcllm[signing] extra)",
      "reason": "HMAC covers 90% of cases with zero deps. ECDSA P-256 for NIST FIPS 186-5 compliance in federal environments. Optional extra keeps base install light.",
      "date": "2026-02-11",
      "alternatives_considered": ["HMAC only", "ECDSA only", "Ed25519"]
    },
    "D-096_signature_scope": {
      "decision": "Sign messages + tools + model name via canonical JSON serialization",
      "reason": "Covers the full request intent. sort_keys=True + compact separators ensures deterministic canonical form.",
      "date": "2026-02-11",
      "alternatives_considered": ["messages only", "full request body", "messages + model only"]
    },
    "D-097_security_phases": {
      "decision": "Single SecurityModule with two phases: PII redaction (pre/post) + signing (post)",
      "reason": "Same module, clear phase ordering. PII redact outbound → call inner → PII redact inbound → sign. Audit sees redacted data (correct stacking order).",
      "date": "2026-02-11",
      "alternatives_considered": ["separate PiiModule + SigningModule", "combined with vault"]
    },
    "D-098_vault_config_layout": {
      "decision": "Global [vault] section in config.toml + per-provider vault_path in provider TOMLs",
      "reason": "Vault backend is global (one vault for entire system). vault_path is per-provider (different secrets for different API keys).",
      "date": "2026-02-11",
      "alternatives_considered": ["all in provider TOML", "all in global config", "environment variables only"]
    },
    "D-099_vault_env_var_handoff": {
      "decision": "VaultResolver sets os.environ[api_key_env] before adapter construction",
      "reason": "Zero adapter changes needed. Adapter reads API key from env var in __init__ as always. Vault resolution is transparent to the adapter layer.",
      "date": "2026-02-11",
      "alternatives_considered": ["pass resolved key to adapter constructor", "adapter calls vault directly"]
    }
  },
  "notes": [
    "Step 1 complete — 7/7 tasks, 20/20 tests passing",
    "Step 2 complete — 5/5 tasks, 10/10 new tests, 30/30 total tests passing in 0.13s",
    "Step 2 review fixes — path traversal prevention (D-035), error path tests, DRY refactor. 45/45 tests, 100% coverage",
    "Step 3 complete — 5/5 tasks, 38 new tests, 83/83 total tests passing in 0.93s",
    "BaseAdapter: concrete base with httpx client, API key resolution, async context manager",
    "AnthropicAdapter: full request/response translation, all 4 content block types, tool call parsing",
    "Mocking: AsyncMock + httpx.Response (not MockTransport) — cleaner for unit testing",
    "Decision log at .claude/decision-log.md (D-001 through D-043)",
    "Step 4 complete — Jupyter notebook + script for live API testing",
    "Step 5 complete — OpenAI adapter with StopReason normalization",
    "Step 6 complete — 5/5 tasks, 13 new tests, 138 total tests passing in 4.19s",
    "Convention-based registry: provider name drives TOML, module, and class lookup",
    "Renamed OpenAIAdapter -> OpenaiAdapter for convention compliance",
    "registry.py: 73 lines — load_model(), clear_cache(), _get_adapter_class()",
    "Module-level config cache — configs loaded once per provider, clear_cache() for testing",
    "Phase 1 (Core Foundation) now COMPLETE — Steps 1-6 all done",
    "Step 6 review — 6-agent swarm review, CONDITIONAL PASS, 3 fixes applied",
    "Step 7 complete — 8/8 tasks, 45 new tests, 194 total tests passing, 98% coverage",
    "Step 7 review — 6-agent swarm, CONDITIONAL PASS, 3 fixes applied (D-052, D-053, D-054)",
    "Step 8 complete — 7/7 tasks, 26 new tests, 244 total passing",
    "Step 8 review — 6-agent swarm, race condition fix in acquire(), DRY test helper, concurrent test added. 245 total.",
    "Step 9 SKIPPED — Router module deferred by user, can add later",
    "Step 10 complete — 6/6 tasks, 21 new telemetry + 7 new registry tests, 272 total passing, 1 skipped",
    "TelemetryModule: structured logging of timing + tokens + cost per invoke()",
    "Cost calculation: (tokens * cost_per_1m) / 1_000_000, supports input/output/cache_read/cache_write",
    "Pricing injection: load_model() reads ModelMetadata costs, merges into telemetry config via setdefault()",
    "Stacking order: Telemetry(Retry(Fallback(RateLimit(adapter)))) — telemetry outermost for total wall-clock",
    "Configurable log level (INFO default), conditional cache_read/write_tokens fields",
    "Validation: negative costs rejected, invalid log levels rejected, missing costs default to 0.0",
    "Next: Step 11 — Audit trail module",
    "Step 10 review — 6-agent swarm, all PASS. Created shared _logging.py helper, added strict config validation, 7 new tests. 289 total.",
    "Step 11 complete — 7/7 tasks, 19 new audit + 3 new registry tests, 311 total passing, 1 skipped",
    "AuditModule: PII-safe metadata logging using log_structured() helper",
    "Conditional fields: tools_provided/tool_calls omitted when not applicable (None omission in log_structured)",
    "Content opt-in: include_messages + include_response flags, logged at DEBUG level (double opt-in)",
    "Stacking order: Telemetry(Audit(Retry(Fallback(RateLimit(adapter)))))",
    "Strict config key validation: _VALID_CONFIG_KEYS catches typos at construction",
    "Next: Step 12 — Budget manager module",
    "OWASP/NIST security analysis complete — 15 agentic threats + LLM Top 10 + NIST 800-53 mapped to ArcLLM's layer",
    "Security decisions: D-075 through D-078 — tool validator as Step 17, content scanner as Step 18, trace context in BaseModule, PII both directions, compliance docs after Step 16",
    "Updated build order: Steps 12-18 + Phase 5 (compliance docs)",
    "Step 12 SKIPPED — Budget manager deferred, jumped to Step 13 (OTel)",
    "Step 13 spec created — 011-otel-export with 10 decisions (D-079 through D-088)",
    "OTel architecture: deep integration (BaseModule _tracer/_span), OtelModule root span, GenAI conventions + arcllm.* attrs",
    "Config: full enterprise (exporter, endpoint, protocol, sample_rate, headers, TLS/mTLS, batch tuning, resource_attributes)",
    "Dependencies: opentelemetry-api core, opentelemetry-sdk + OTLP as [otel] extras",
    "Next: T13.1 — Add opentelemetry-api to core deps",
    "Step 13 complete — 10/10 tasks, 56 new tests, 379 total passing, 1 skipped",
    "OtelModule: root span with GenAI semantic conventions (gen_ai.system, gen_ai.request.model, gen_ai.usage.*, gen_ai.response.*)",
    "BaseModule: _tracer property (trace.get_tracer('arcllm')) + _span() context manager with exception recording",
    "All modules instrumented: retry (retry+attempt spans), fallback (fallback+attempt spans), rate_limit (wait_ms attr), telemetry (duration+cost attrs), audit (metadata attrs)",
    "Config-driven SDK setup: exporter (otlp/console/none), endpoint, protocol (grpc/http), sample_rate, headers, TLS/mTLS, batch tuning",
    "opentelemetry-api as core dep, SDK+OTLP as [otel] extras",
    "Stacking order: Otel(Telemetry(Audit(Retry(Fallback(RateLimit(adapter))))))",
    "Next: Step 14 — Security layer (vault, signing, PII redaction)",
    "Step 14 complete — 12/12 tasks, 72 new tests (26 PII + 13 signing + 14 vault + 19 security), 451 total passing, 1 skipped",
    "Security layer: VaultResolver (construction-time key resolution) + SecurityModule (per-invoke PII redaction + request signing)",
    "_pii.py: PiiDetector protocol, RegexPiiDetector with 5 built-in patterns (SSN, CC, email, phone, IPv4), custom pattern support, redact_text() with type-tagged placeholders",
    "_signing.py: HMAC-SHA256 default (stdlib), ECDSA P-256 stub (arcllm[signing] extra), canonical_payload() with sort_keys=True",
    "vault.py: VaultBackend protocol, VaultResolver with TTL cache (time.monotonic()), vault-first + env-var-fallback, backend loaded via importlib",
    "SecurityModule: 4 phases (PII redact outbound → call inner → PII redact inbound → sign), OTel spans per phase",
    "Stacking order: Otel → Telemetry → Audit → Security → Retry → Fallback → RateLimit → Adapter",
    "Coverage: _pii 100%, _signing 97%, vault 92%, security 89%",
    "Decisions D-089 through D-099 recorded",
    "Next: Step 15 — Local providers (Ollama, vLLM)"
  ],
  "meta": {
    "last_updated": "2026-02-11",
    "created": "2026-02-07"
  }
}
